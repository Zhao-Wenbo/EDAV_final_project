# Results

```{r ch05-0}
df_data <- read_csv("./WDI_csv/WDIData.csv") %>% select(!last_col())
df_data_missing <- read_csv("./WDI_csv/WDI_Data_missing.csv")
df_selected_country <- read_csv("./WDI_csv/selected_countries.csv")
df_selected_indicator <- read_csv("./WDI_csv/selected_indicators.csv")
df_selected_country$`Income Group` <- df_selected_country$`Income Group` %>% 
  factor(levels=c("Low income", "Lower middle income", "Upper middle income", "High income"))
tsize <- 15
```

## Does the increase of education attainment and better overall economic condition decrease the income inequality?
We would like to investigate on the education enrollment conditions. However most of the indicators with `Education` topic have a high percentage of missing, lacking the data of more than 100 countries on average, making it hard to analysis on a comprehensive way. We choose one critical indicator `Primary completion rate, total (% of relevant age group)` and have a closer look into its condition of missing values.

```{r ch05-1-1, fig.width=10}
# name the chunks to avoid conflict
df_edu_temp <- merge(df_selected_country %>% select(c(1,2)), 
                     cbind(df_selected_country %>% select("Country Name"),
                       df_data_missing %>% filter(`Indicator Code` == "SE.PRM.CMPT.ZS") %>% 
                       select(!c(1,2,3,4)) %>% is.na()),
                     by="Country Name")

edu_missing <-  df_edu_temp %>% 
  group_by(`Income Group`) %>% 
  summarise(across(`1971`:`2018`, mean)) %>% 
  ungroup() %>% 
  pivot_longer(!c("Income Group"), names_to="Year", values_to="Missing Rate")

edu_missing$`Income Group` <- edu_missing$`Income Group` %>% 
  factor(levels=c("Low income", "Lower middle income", "Upper middle income", "High income"))
edu_missing$Year <- as.integer(edu_missing$Year)

ggplot(edu_missing, aes(x=Year, y=`Missing Rate`, color=fct_rev(`Income Group`))) +
  geom_line() +
  theme(text = element_text(size = tsize)) +
  scale_color_discrete(name="Income Group") +
  ggtitle("Missing Rate of Primary Completion Rate Records")

```

We can see that the missing records in high-income countries is even higher than that of low-income countries. In addition, since education has been a heated topic only in the few decades, we can observe that there is fewer missing values only after 1998. Therefore, we can only explore the problem related to education in a shorter period, 1999 - 2017, than others. In addition, the missing rate are similar in different income groups, which dispels the misgiving that removing the countries with no data will lead to a biased distribution between income groups.

Unfortunately, the income distribution data, such as `Income share held by lowest 20%`, `Income share held by highest 20%`, has too much missing values to study. Only the data of about 30 countries recorded, making it impossible to investigate on the general trend worldwide. Therefore, we had to turn to another indicator with more complete data. We choose `Life expectancy at birth, total` as a good substitute since it can reflect the overall well-being of a country.

To investigate on the correlation between education and life expectancy, we first draw a plot at year 2010.

```{r ch05-1-2, fig.width=10}
df_life_exp <- merge(df_selected_country %>% select(c(1,2)), 
                     cbind(df_selected_country %>% select("Country Name"),
                           df_data %>% 
                             filter(`Indicator Code` == "SP.DYN.LE00.IN") %>% 
                             filter(`Country Name` %in% df_selected_country$`Country Name`) %>% 
                             select(df_data_missing %>% colnames()) %>% 
                             select(!c(1,2,3,4))),
                     by="Country Name")
df_edu <- merge(df_selected_country %>% select(c(1,2)), 
                     cbind(df_selected_country %>% select("Country Name"),
                           df_data_missing %>% filter(`Indicator Code` == "SE.PRM.CMPT.ZS") %>% 
                             select(!c(1,2,3,4))),
                     by="Country Name")

life_exp_2010 <- df_life_exp %>% select(c(`Country Name`, `2010`))
colnames(life_exp_2010)[2] <- "Life Expectancy"
edu_2010 <- df_edu %>% select(c(`Country Name`, `2010`))
colnames(edu_2010)[2] <- "Primary Completion Rate"

df_life_edu_2010 <- merge(life_exp_2010, edu_2010, by="Country Name")

ggplot(df_life_edu_2010, aes(x=`Primary Completion Rate`, y=`Life Expectancy`)) +
  geom_point(na.rm=TRUE) +
  geom_smooth(na.rm=TRUE, method=lm, se=FALSE) +
  theme(text = element_text(size = tsize)) +
  ylab("Life Expectancy, years") +
  xlab("Primary Completion Rate, %") +
  ggtitle("Primary Completion Rate vs Life Expecctancy in 2010")
  
```

From the plot, we can see a obvious positive correlation between the primary completion and the life expectancy. Here we need to note that the primary completion rate can be more than 100 since it is the fraction of students enrolled in the last year divided by the students enrolled in the first year, thus the situation of repeating and inserting will lead to a higher completion rate than expected. Although we can not draw the conclusion that higher primary complete rate directly leads to a higher life expectancy, we can say that they are highly correlated and both are indicators of the overall well-being of a country.

After that, we would like to see the change of education indicators and life expectancy in a longer run.

```{r ch05-1-3, fig.width=10}
groups=c("Low income", "Lower middle income", "Upper middle income", "High income")

df_life_exp_group <- df_data %>% 
                             filter(`Indicator Code` == "SP.DYN.LE00.IN") %>% 
                             filter(`Country Name` %in% groups) %>% 
                             select(df_data_missing %>% colnames()) %>% 
                             select(!c(2,3,4))

df_life_exp_group$`Country Name` <- df_life_exp_group$`Country Name` %>% 
  factor(levels=c("Low income", "Lower middle income", "Upper middle income", "High income"))

df_life_exp_group <- df_life_exp_group %>% 
  select(!c("1971":"1998","2018")) %>% 
  pivot_longer(-1, values_to="life", names_to="year")


df_edu_group <- df_data %>% 
  filter(`Indicator Code` == "SE.PRM.CMPT.ZS") %>% 
  filter(`Country Name` %in% groups) %>% 
  select(df_data_missing %>% colnames()) %>% 
  select(!c(2,3,4))

df_edu_group$`Country Name` <- df_edu_group$`Country Name` %>% 
  factor(levels=c("Low income", "Lower middle income", "Upper middle income", "High income"))

df_edu_group <- df_edu_group %>% 
  select(!c("1971":"1998","2018"))%>% 
  pivot_longer(-1, values_to="edu", names_to="year")

df_life_edu_group <- merge(df_life_exp_group, df_edu_group, by=c("Country Name", "year"))
df_life_edu_group$year <- as.integer(df_life_edu_group$year)

ggplot(df_life_edu_group) +
  theme(text = element_text(size = tsize)) +
  geom_line(mapping=aes(x=year, y=edu, color=fct_rev(`Country Name`))) +
  geom_point(mapping=aes(x=year, y=life, color=fct_rev(`Country Name`))) +
  xlab("Year") +
  ylab("Primary Completion Rate, line, %\n Life Expectancy, dot, year") +
  scale_color_discrete(name="Income Group") +
  ggtitle("Change of primary completion rate (line, %)\nand life expectancy (dot, years)")
```

From the plot we can that both the primary completion rate and life expectancy increase with higher income group. The primary completion rate in higher- and upper-middle-countries are always in the high range and that of lower-middle and low-income countries also grow repidly thanks to the increasing focus of foundamental education in these areas.

## Is there a corelation between greenhouse emissions and financial indicators, quality of life, etc?
We first examine the emission of greenhouse gases per capita facet by the income group. We choose the year 2000 can draw a boxplot to see the overall distribution.
```{r ch05-2-1, fig.height=5, fig.width=10}
df_2010_co2 <- merge(df_selected_country %>% select(c(1,2)), 
                     df_data_missing %>% filter(`Indicator Code` == "EN.ATM.CO2E.PC") %>% 
                       select(c("Country Name", "2010")),
                     by="Country Name")

colnames(df_2010_co2)[3] <- "co2 per capita"
ggplot(df_2010_co2, aes(x=`co2 per capita`, y=`Income Group`)) + 
  geom_boxplot(na.rm=TRUE) +
  theme(text = element_text(size = tsize)) +
  xlab("CO2 emission per capita in 2010 (tons)") + 
  ggtitle("Boxplot of CO2 emission per capita")

```

From the plot, we can see the evidence that countries with higher income emit more co2 per person. Most of the low-income countries emit almost negligible co2 compared with high-income countries. However, this may due to the fact that the production of high-value product requires more energy and low-income countries tend to have  bigger population. Therefore, we also investigate on the greenhouse emission per 2015 US$.

```{r ch05-2-2, fig.height=5, fig.width=10}
df_2010_co2 <- merge(df_2010_co2, 
                     df_data_missing %>% filter(`Indicator Code` == "EN.ATM.CO2E.KD.GD") %>% 
                       select(c("Country Name", "2010")),
                     by="Country Name")

colnames(df_2010_co2)[4] <- "co2 per 2015 US$"
ggplot(df_2010_co2, aes(x=`co2 per 2015 US$`, y=`Income Group`)) + 
  geom_boxplot(na.rm=TRUE) +
  theme(text = element_text(size = tsize)) +
  xlab("CO2 emission per 2015 US$ in 2010 (kg)") +
  # scale_y_discrete(position = "right") +
  ggtitle("Boxplot of CO2 emission per 2015 US$")
```

This plot gives us some different insight against the former one. The plot shows that high and low income countries emit relatively fewer co2 to generate unit GDP than that of middle countries. The reason may comes from the fact that high-income countries have a wholesome system of service sector that can make a lot of profit with relatively low pollution while the low-income countries focus on fundamental livings which also emit few co2. In contrast, middle-income countries may focus on industrial section, which will emit high amount of co2 for each unit of GDP.

At last, we would like see the annually varying situation of the two above-mentioned metrics.

```{r ch05-2-3, fig.width=10}
df_co2 <- df_data_missing %>% 
  filter(`Indicator Code` == "EN.ATM.CO2E.KT") %>% 
  select(!c("Country Code", "Indicator Name", "Indicator Code")) %>% 
  column_to_rownames("Country Name")
df_population <- df_data_missing %>% 
  filter(`Indicator Code` == "SP.POP.TOTL") %>% 
  select(!c("Country Code", "Indicator Name", "Indicator Code")) %>% 
  column_to_rownames("Country Name")
df_gdp <- df_data_missing %>% 
  filter(`Indicator Code` == "NY.GDP.MKTP.KD") %>% 
  select(!c("Country Code", "Indicator Name", "Indicator Code")) %>% 
  column_to_rownames("Country Name")

df_co2_temp <- df_co2 * !is.na(df_population)
df_population_temp <- df_population * !is.na(df_co2)
df_co2_temp <- merge(df_selected_country %>% select(c("Country Name", "Income Group")), 
                     df_co2_temp %>% rownames_to_column("Country Name"),
                     by="Country Name")
df_population_temp <- merge(df_selected_country %>% select(c("Country Name", "Income Group")), 
                            df_population_temp %>% rownames_to_column("Country Name"),
                            by="Country Name")

df_co2_group <- df_co2_temp %>% 
  select(!1) %>% 
  group_by(`Income Group`) %>% 
  summarise(across("1971":"2018", sum, na.rm=TRUE)) %>%  
  ungroup()

df_population_group <- df_population_temp %>% 
  select(!1) %>% 
  group_by(`Income Group`) %>% 
  summarise(across("1971":"2018", sum, na.rm=TRUE)) %>%  
  ungroup()

df_co2_pc_group <- (df_co2_group %>% column_to_rownames("Income Group") / 
  df_population_group %>% column_to_rownames("Income Group") * 1000) %>% 
  rownames_to_column("Income Group") %>%
  pivot_longer(cols=-1, names_to="year")

df_co2_pc_group$`Income Group` <- df_co2_pc_group$`Income Group` %>% 
  factor(levels=c("Low income", "Lower middle income", "Upper middle income", "High income"))

df_co2_pc_group$year <- as.integer(df_co2_pc_group$year)
ggplot(df_co2_pc_group, aes(x=year, y=value, color=fct_rev(`Income Group`))) +
  geom_line() +
  theme(text = element_text(size = tsize)) +
  ylab("CO2 emission per capita (ton)") +
  scale_color_discrete(name="Income Group") +
  ggtitle("Change of CO2 emission per capita")
```

We can see that the trend is close to what is shown in the boxplot of CO2 emission per capita, which increases with the increase of income group. We can also observe that the emission per capita in high-income countries drops in the recent years, which may credits to the development of service section and the arise of environment-protect activities. On the other hand, the emission in upper-middle-income countries bursts after 2000, because of the rapid industrialization in these countries. Also, we can observe that the emission of lower-middle-income countries and low-income countries have a cross at about 1990, while the record of upper middle income countries drop sharply at the same time, because the additional data brought by the disassembly of Soviet Union.

Similarly, we want to discover the annually change in CO2 emission per 2015 US$ by plotting a line graph.

```{r ch05-2-4, fig.width=10}
df_co2_temp <- df_co2 * !is.na(df_gdp)
df_gdp_temp <- df_gdp * !is.na(df_co2)
df_co2_temp <- merge(df_selected_country %>% select(c("Country Name", "Income Group")), 
                     df_co2_temp %>% rownames_to_column("Country Name"),
                     by="Country Name")
df_gdp_temp <- merge(df_selected_country %>% select(c("Country Name", "Income Group")), 
                            df_gdp_temp %>% rownames_to_column("Country Name"),
                            by="Country Name")

df_co2_group <- df_co2_temp %>% 
  select(!1) %>% 
  group_by(`Income Group`) %>% 
  summarise(across("1971":"2018", sum, na.rm=TRUE)) %>%  
  ungroup()

df_gdp_group <- df_gdp_temp %>% 
  select(!1) %>% 
  group_by(`Income Group`) %>% 
  summarise(across("1971":"2018", sum, na.rm=TRUE)) %>%  
  ungroup()

df_co2_pdollar_group <- (df_co2_group %>% column_to_rownames("Income Group") / 
                    df_gdp_group %>% column_to_rownames("Income Group") * 10^6) %>% 
  rownames_to_column("Income Group") %>%
  pivot_longer(cols=-1, names_to="year")

df_co2_pdollar_group$`Income Group` <- df_co2_pdollar_group$`Income Group` %>% 
  factor(levels=c("Low income", "Lower middle income", "Upper middle income", "High income"))

df_co2_pdollar_group$year <- as.integer(df_co2_pdollar_group$year)
ggplot(df_co2_pdollar_group, aes(x=year, y=value, color=fct_rev(`Income Group`))) +
  geom_line() +
  theme(text = element_text(size = tsize)) +
  ylab("CO2 emission per 2015 US$ (kg)") +
  scale_color_discrete(name="Income Group") +
  ggtitle("Change of CO2 emission per 2015 US$")
```

From the plot, we can reconfirm the boxplot for year 2010 that middle income countries emits more CO2 to produce unit GDP while high-income and low-income emits less. We also see a sharp spike at about 1990 in upper-middle and lower-middle-income countries, which also owes to the disassembly of the Soviet Union. In addition, except for the low-income countries, the world shows a steady drop of CO2 emission per dollar after 1990, owing to the fact that the development of technology can practically reduce the CO2 emission per product.

## Does richer countries use more renewable sources for electricity production and does this indeed reduce the emission of CO2 and NOx?
123
```{r ch05-3-1}
# name the chunks to avoid conflict
```