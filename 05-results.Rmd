# Results

```{r ch05-01}
df_data_missing <- read_csv("./WDI_csv/WDI_Data_missing.csv")
df_selected_country <- read_csv("./WDI_csv/selected_countries.csv")
df_selected_indicator <- read_csv("./WDI_csv/selected_indicators.csv")
df_selected_country$`Income Group` <- df_selected_country$`Income Group` %>% 
  factor(levels=c("Low income", "Lower middle income", "Upper middle income", "High income"))
tsize <- 15
```
```{r pivot dataset}
# pivot the data from wide to long
country_income_group <- df_selected_country %>%
  select(`Country Name`,`Income Group`)
df_panel <- df_data_missing %>% 
  # first wrangle column of years into rows
  pivot_longer(cols = "1971":"2018",names_to = "Year")%>% 
  # then pivot rows of indicator into columns
  pivot_wider(id_cols = c(`Country Name`,Year),names_from = `Indicator Code`,values_from = value)%>%
  left_join(country_income_group,by = "Country Name")%>%
  mutate(Year = as.numeric((Year)))%>%
  select(`Country Name`,Year,`Income Group`,everything())

head(df_panel)

df_indicators <- df_data_missing %>%
  distinct(`Indicator Name`,`Indicator Code`)
```

## Does the increase of education attainment and better overall economic condition decrease the income inequality?
123
```{r ch05-1-1}
# name the chunks to avoid conflict

```

## Is there a corelation between greenhouse emissions and financial indicators, quality of life, etc?
We first examine the emission of greenhouse gases per capita facet by the income group. We choose the year 2000 can draw a boxplot to see the overall distribution.
```{r ch05-2-1, fig.height=5, fig.width=10}
df_2010_co2 <- merge(df_selected_country %>% select(c(1,2)), 
                     df_data_missing %>% filter(`Indicator Code` == "EN.ATM.CO2E.PC") %>% 
                       select(c("Country Name", "2010")),
                     by="Country Name")

colnames(df_2010_co2)[3] <- "co2 per capita"
ggplot(df_2010_co2, aes(x=`co2 per capita`, y=`Income Group`)) + 
  geom_boxplot(na.rm=TRUE) +
  theme(text = element_text(size = tsize)) +
  xlab("CO2 emission per capita in 2010 (tons)") + 
  ggtitle("Boxplot of CO2 emission per capita")

```

From the plot, we can see the evidence that countries with higher income emit more co2 per person. Most of the low-income countries emit almost negligible co2 compared with high-income countries. However, this may due to the fact that the production of high-value product requires more energy and low-income countries tend to have  bigger population. Therefore, we also investigate on the greenhouse emission per 2015 US$.

```{r ch05-2-2, fig.height=5, fig.width=10}
df_2010_co2 <- merge(df_2010_co2, 
                     df_data_missing %>% filter(`Indicator Code` == "EN.ATM.CO2E.KD.GD") %>% 
                       select(c("Country Name", "2010")),
                     by="Country Name")

colnames(df_2010_co2)[4] <- "co2 per 2015 US$"
ggplot(df_2010_co2, aes(x=`co2 per 2015 US$`, y=`Income Group`)) + 
  geom_boxplot(na.rm=TRUE) +
  theme(text = element_text(size = tsize)) +
  xlab("CO2 emission per 2015 US$ in 2010 (kg)") +
  # scale_y_discrete(position = "right") +
  ggtitle("Boxplot of CO2 emission per 2015 US$")
```

This plot gives us some different insight against the former one. The plot shows that high and low income countries emit relatively fewer co2 to generate unit GDP than that of middle countries. The reason may comes from the fact that high-income countries have a wholesome system of service sector that can make a lot of profit with relatively low pollution while the low-income countries focus on fundamental livings which also emit few co2. In contrast, middle-income countries may focus on industrial section, which will emit high amount of co2 for each unit of GDP.

At last, we would like see the annually varying situation of the two above-mentioned metrics.

```{r ch05-2-3, fig.width=10}
df_co2 <- df_data_missing %>% 
  filter(`Indicator Code` == "EN.ATM.CO2E.KT") %>% 
  select(!c("Country Code", "Indicator Name", "Indicator Code")) %>% 
  column_to_rownames("Country Name")
df_population <- df_data_missing %>% 
  filter(`Indicator Code` == "SP.POP.TOTL") %>% 
  select(!c("Country Code", "Indicator Name", "Indicator Code")) %>% 
  column_to_rownames("Country Name")
df_gdp <- df_data_missing %>% 
  filter(`Indicator Code` == "NY.GDP.MKTP.KD") %>% 
  select(!c("Country Code", "Indicator Name", "Indicator Code")) %>% 
  column_to_rownames("Country Name")

df_co2_temp <- df_co2 * !is.na(df_population)
df_population_temp <- df_population * !is.na(df_co2)
df_co2_temp <- merge(df_selected_country %>% select(c("Country Name", "Income Group")), 
                     df_co2_temp %>% rownames_to_column("Country Name"),
                     by="Country Name")
df_population_temp <- merge(df_selected_country %>% select(c("Country Name", "Income Group")), 
                            df_population_temp %>% rownames_to_column("Country Name"),
                            by="Country Name")

df_co2_group <- df_co2_temp %>% 
  select(!1) %>% 
  group_by(`Income Group`) %>% 
  summarise(across("1971":"2018", sum, na.rm=TRUE)) %>%  
  ungroup()

df_population_group <- df_population_temp %>% 
  select(!1) %>% 
  group_by(`Income Group`) %>% 
  summarise(across("1971":"2018", sum, na.rm=TRUE)) %>%  
  ungroup()

df_co2_pc_group <- (df_co2_group %>% column_to_rownames("Income Group") / 
  df_population_group %>% column_to_rownames("Income Group") * 1000) %>% 
  rownames_to_column("Income Group") %>%
  pivot_longer(cols=-1, names_to="year")

df_co2_pc_group$`Income Group` <- df_co2_pc_group$`Income Group` %>% 
  factor(levels=c("Low income", "Lower middle income", "Upper middle income", "High income"))

df_co2_pc_group$year <- as.integer(df_co2_pc_group$year)
ggplot(df_co2_pc_group, aes(x=year, y=value, color=fct_rev(`Income Group`))) +
  geom_line() +
  theme(text = element_text(size = tsize)) +
  ylab("CO2 emission per capita (ton)") +
  scale_color_discrete(name="Income Group") +
  ggtitle("Change of CO2 emission per capita")
```

We can see that the trend is close to what is shown in the boxplot of CO2 emission per capita, which increases with the increase of income group. We can also observe that the emission per capita in high-income countries drops in the recent years, which may credits to the development of service section and the arise of environment-protect activities. On the other hand, the emission in upper-middle-income countries bursts after 2000, because of the rapid industrialization in these countries. It is interesting so see that the emission of lower-middle-income countries and low-income countries have a cross at about 1990, while the record of upper middle income countries drop sharply at the same time. After looking into the data, the reason lies in the disassembly of the Soviet Union, which adds several countries that doesn't exist in the data set and lead to a fluctuation in records.

Similarly, we want to discover the annually change in CO2 emission per 2015 US$ by plotting a line graph.

```{r ch05-2-4, fig.width=10}
df_co2_temp <- df_co2 * !is.na(df_gdp)
df_gdp_temp <- df_gdp * !is.na(df_co2)
df_co2_temp <- merge(df_selected_country %>% select(c("Country Name", "Income Group")), 
                     df_co2_temp %>% rownames_to_column("Country Name"),
                     by="Country Name")
df_gdp_temp <- merge(df_selected_country %>% select(c("Country Name", "Income Group")), 
                            df_gdp_temp %>% rownames_to_column("Country Name"),
                            by="Country Name")

df_co2_group <- df_co2_temp %>% 
  select(!1) %>% 
  group_by(`Income Group`) %>% 
  summarise(across("1971":"2018", sum, na.rm=TRUE)) %>%  
  ungroup()

df_gdp_group <- df_gdp_temp %>% 
  select(!1) %>% 
  group_by(`Income Group`) %>% 
  summarise(across("1971":"2018", sum, na.rm=TRUE)) %>%  
  ungroup()

df_co2_pdollar_group <- (df_co2_group %>% column_to_rownames("Income Group") / 
                    df_gdp_group %>% column_to_rownames("Income Group") * 10^6) %>% 
  rownames_to_column("Income Group") %>%
  pivot_longer(cols=-1, names_to="year")

df_co2_pdollar_group$`Income Group` <- df_co2_pdollar_group$`Income Group` %>% 
  factor(levels=c("Low income", "Lower middle income", "Upper middle income", "High income"))

df_co2_pdollar_group$year <- as.integer(df_co2_pdollar_group$year)
ggplot(df_co2_pdollar_group, aes(x=year, y=value, color=fct_rev(`Income Group`))) +
  geom_line() +
  theme(text = element_text(size = tsize)) +
  ylab("CO2 emission per 2015 US$ (kg)") +
  scale_color_discrete(name="Income Group") +
  ggtitle("Change of CO2 emission per 2015 US$")
```

From the plot, we can reconfirm the boxplot for year 2010 that middle income countries emits more CO2 to produce unit GDP while high-income and low-income emits less. We also see a sharp spike at about 1990 in upper-middle and lower-middle-income countries, which also owes to the disassembly of the Soviet Union. In addition, except for the low-income countries, the world shows a steady drop of CO2 emission per dollar after 1990, owing to the fact that the development of technology can practically reduce the CO2 emission per product.

## Does richer countries use more renewable sources for electricity production and does this indeed reduce the emission of CO2 and NOx?


```{r ch05-3-1, fig.width=10}

df_renewable_energy <- df_panel %>%
  group_by(`Income Group`,Year)%>%
  summarize(`Other Sources` = mean(EG.ELC.RNEW.ZS,na.rm = TRUE),`Nuclear Sources` = mean(EG.ELC.NUCL.ZS,na.rm = TRUE))%>%
  mutate(`Other Sources` = replace_na(`Other Sources`,0),`Nuclear Sources` = replace_na(`Nuclear Sources`,0))%>%
  mutate(`All Renewable Sources` = `Other Sources` + `Nuclear Sources`)%>%
  pivot_longer(cols = `Other Sources`:`All Renewable Sources`,names_to = "Renewable Energy Type")%>%
  mutate(`Income Group` = fct_rev(`Income Group`))%>%
  ungroup()%>%
  filter(Year >1990 & Year < 2016)
 
# electricity production from renewable sources, break down by country and type  
df_renewable_energy%>%
  ggplot(aes(x = Year,y = value,color = `Renewable Energy Type`)) + 
    geom_point(position=position_jitter(w=0.2),alpha = 0.8)+
  geom_line(position=position_jitter(w=0.2),alpha = 0.8)+
  facet_grid(~`Income Group`)+
  scale_x_discrete(breaks = round(seq(1971, 2018, by = 10))) +
  theme(legend.position = "bottom",text = element_text(size = tsize))+
  labs(x = " ",y = "Percentage")+
  ggtitle("Electricity Production from Renewable Sources",subtitle = "% of total production")
    
```

```{r}
sum(is.na(df_panel$EN.ATM.CO2E.PC))
```

```{r ch05-3-2, fig.width=10}
 
# does renewable energy corresponds to decrease in emission?

# EN.ATM.CO2E.KD.GD	
# EN.ATM.CO2E.PC
# 
# EN.ATM.NOXE.EG.ZS
# 	EN.CO2.ETOT.ZS

df_emission <- df_panel %>%
  group_by(`Income Group`,Year)%>%
  summarize(`CO2 per 2015 USD` = mean(EN.ATM.CO2E.KD.GD,na.rm = TRUE),
            `CO2 per Capita` = mean(EN.ATM.CO2E.PC,na.rm = TRUE))%>%
  mutate(`CO2 per 2015 USD` = replace_na(`CO2 per 2015 USD`,0),
         `CO2 per Capita` = replace_na(`CO2 per Capita`,0),
         `Income Group` = fct_rev(`Income Group`))

df_3_2<-df_renewable_energy %>%
  filter(`Renewable Energy Type` == "All Renewable Sources")%>%
  mutate(all_renewable = value)%>%
  select(`Income Group`,Year,all_renewable)


emission_and_renewable <- df_emission %>%
  left_join(df_3_2,by = c("Income Group","Year"))%>%
  filter(Year >1990 & Year < 2016)%>%
  # convert to 0 - 1
  mutate(all_renewable = all_renewable/100)%>%
  # min max scaling for emission
  mutate_at(vars(`CO2 per 2015 USD`:`CO2 per Capita`),~scales::rescale(.x,to = c(0,1)))

emission_and_renewable%>%
  pivot_longer(cols = `CO2 per 2015 USD`:all_renewable,names_to = "series name")%>%
  ggplot(aes(x = Year,y = value,color = `series name`))+
  geom_point()+
  geom_smooth(method = "loess",se=FALSE,span = 0.4,lwd = 0.5)+
  facet_grid(~`Income Group`)+
  scale_x_continuous(name= " ",breaks = round(seq(1990, 2016, by = 10))) +
  theme(legend.position = "bottom",text = element_text(size = tsize))+
  labs(y = "Standardized Value")+
  scale_color_discrete(name = " ", labels = c("Renewable Electricity %", "CO2 per 2015 USD", "CO2 per Capita"))+
  ggtitle("Comparison of renewable energy source and CO2 emission")

```

```{r}

```

